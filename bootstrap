#!/bin/sh
set -e

if [ -f /etc/redhat-release ]; then
    for package in python-virtualenv python-devel libevent-devel libffi-devel libxml2-devel libxslt-devel zlib-devel; do
        if [ "$(rpm -qa $package 2>/dev/null)" == "" ]; then
            missing="${missing:+$missing }$package"
        fi
    done
    if [ -n "$missing" ]; then
        echo "$0: missing required RPM packages. Installing via sudo." 1>&2
        sudo yum -y install $missing
    fi
fi

if [ -f certificates/Citi_DEVELOPMENT_chain.pem ]; then
  sudo cp certificates/Citi_DEVELOPMENT_chain.pem /etc/pki/ca-trust/source/anchors/
  sudo update-ca-trust extract
fi

virtualenv --no-site-packages --distribute virtualenv

# avoid pip bugs
./virtualenv/bin/pip install --upgrade pip --no-index --find-links="dependencies/pip/"

# slightly old version of setuptools; newer fails w/ requests 0.14.0
./virtualenv/bin/pip install setuptools==32.3.1 --no-index --find-links="dependencies/pip/"

./virtualenv/bin/pip install -r requirements.txt --no-index --find-links="dependencies/pip/"

# forbid setuptools from using the network because it'll try to use
# easy_install, and we really wanted pip; next line will fail if pip
# requirements.txt does not match setup.py requirements -- sucky but
# good enough for now
./virtualenv/bin/python setup.py develop

# for use with local scripts
#pip install -r requirements-local.txt --no-index --user --find-links="dependencies/pip/"
