#!/bin/sh
set -e

if [ -f /etc/redhat-release ]; then
    for package in python-virtualenv python-devel libevent libxml2-devel libxslt-devel zlib-devel; do
        if [ "$(rpm -qa $package 2>/dev/null)" = "" ]; then
            missing="${missing:+$missing }$package"
        fi
    done
    if [ -n "$missing" ]; then
        echo "$0: missing required RPM packages. Installing via sudo." 1>&2
		cd ./devtools
        sudo yum -y localinstall $missing
		cd .. #./s3-tests-7.3
    fi
fi

virtualenv --no-site-packages --distribute virtualenv

# avoid pip bugs
#./virtualenv/bin/pip install --upgrade pip

# slightly old version of setuptools; newer fails w/ requests 0.14.0
#./virtualenv/bin/pip install setuptools==32.3.1
#./virtualenv/bin/pip install -r requirements.txt
./virtualenv/bin/pip install setuptools --find-links=./piprepo/ --no-index --use-wheel
./virtualenv/bin/pip install -r requirements.txt --find-links=./piprepo/ --no-index --use-wheel

# forbid setuptools from using the network because it'll try to use
# easy_install, and we really wanted pip; next line will fail if pip
# requirements.txt does not match setup.py requirements
./virtualenv/bin/python setup.py develop

